#### "press" a cell
#### 1. generate wall
#### 2. press cell to the wall
#### 3. detach cell from the wall
# sTEST: rbc.press.long
set -eu
S=`pwd` U=u/x C="$S/conf/lina.h"
cd "$S"/test/rbc/press
ae  ()   { awk "BEGIN {print $*}"; }
mv0 ()   { if test -d "$2"; then rm -r "$2"; fi; mv "$1" "$2"; }
make0 () { make clean && u.make -j; }
ic  () {
    local x y z cs si
    x=`ae $XS/2` y=`ae $YS/2` z=6
    cs=0 si=1
    echo 1   0    0  $x \
	 0 $cs -$si  $y \
	 0 $si  $cs  $z \
	 0   0   0   1  \
    > rbcs-ic.txt
}
ini () {
    local a b c
    inf=999999999
    nv=2562
    XS=20 YS=20 ZS=20
    p=5.0 x0=0.5 ka=0.05 kb=0.0001 kd=0.002 kv=0.05 kbt=1e-7 gamma=0
    a="RBCp=$p RBCx0=$x0 RBCkb=$kb RBCgammaC=$gamma"
    b="RBCka=$ka RBCkv=$kv RBCkd=$kd"
    c="RBC_RND=false kBT=$kbt"
    Memb="$a $b $c"
    c0=$S/data/cells/rbc/$nv.off
    c1=$S/data/cells/rbc/$nv.off
    volume=`off.volume $c1` area=`off.area $c1`
    cp $c0          rbc.stress.free
    cp $c1          rbc.off
    cp "$S/data/sdf/yplates1/yplates.dat" sdf.dat
    Rbc="dt=1e-4 rbc_ids rbc_com_dumps RBC_STRESS_FREE RBCnv=$nv RBCtotArea=$area RBCtotVolume=$volume pushrbc"
    Domain="XS=$XS YS=$YS ZS=$ZS"
}
wall () {
    u.conf "$S" "$U" "$C" <<!
    MESH_SHIFT_CENTER $Memb $Rbc $Domain
    walls wall_creation=1000
    strt_dumps strt_freq=$inf
    tend=0.11
    run
!
    make0 > .make
    ic
    u.strtdir
    sh runfile
    mv0 r r.wall
}
down () {
    u.conf "$S" "$U" "$C" <<!
    MESH_SHIFT_CENTER $Memb $Rbc $Domain
    pushflu=false
    walls wall_creation=0
    RESTART=true
    FORCE_CONSTANT FORCE_PAR_A=$A
    strt_dumps strt_freq=$inf
    tend=16.1 part_freq=5000
    run
!
    make0 > .make
    FORCE_PAR_EX=0 FORCE_PAR_EY=-1 FORCE_PAR_EZ=0 sh runfile
    mv0 com com.down
    mv0   r   r.down
}
up () {
    u.conf "$S" "$U" "$C" <<!
    MESH_SHIFT_CENTER $Memb $Rbc $Domain
    pushflu=false
    walls wall_creation=0
    RESTART=true
    FORCE_CONSTANT FORCE_PAR_A=$A
    tend=16.1 part_freq=5000
    run
!
    make0 > .make
    FORCE_PAR_EX=0 FORCE_PAR_EY=1 FORCE_PAR_EZ=0 sh runfile
    mkdir -p r.up com.up
    mv0 r     r.up/$A
    mv0 com com.up/$A
}
ini
wall
A=10.0 down
A=0.0  up
