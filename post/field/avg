#!/usr/bin/env octave-qf

1;

function D = read(f)
  D = load(f);
  D = orderfields(D); # alphabetically
  D = structfun(@squeeze, D, "UniformOutput", false);
endfunction

function S = add0(S, D, n, f)
  s = S.(f); x = D.(f);
  # moving sum
  s  = (n - 1) * s + x;
  s /= n;
  S.(f) = s;
endfunction
function S = add1(S, D, n)
  ff = fieldnames(S);
  nf = numel(ff);
  for i = 1:nf; f = ff{i}; S = add0(S, D, n, f); endfor
endfunction

function S = add(S, D, n)
  if n == 1; S = D; else S = add1(S, D, n); endif
endfunction

function values(S)
  ini_val("o.values");
  values0(S)
  fin_val();
endfunction

function S = cellfun0(f, S, varargin)
  S = cellfun(f, S, "UniformOutput", false, varargin{:});
endfunction

function values0(S)
  S = struct2cell(S);
  S = cellfun0(@(v) v(:), S);
  S = horzcat(S{:});
  S = S'(:);
  w_val(S, "single");
endfunction

function w_bov(fmt, varargin)
  global bov_f
  fmt = strcat(fmt, "\n");
  fprintf(bov_f, fmt, varargin{:});
endfunction

function w_val(v)
  global val_f
  fwrite(val_f, v, "single");
endfunction

function bov0(S)
  sz = size(S.u);
  dc = numel(fieldnames(S));
  fn = "o.values";
  vn = "V";
  w_bov("DATA_FILE: %s", fn)
  w_bov("DATA_SIZE: %d %d %d", sz)
  w_bov("DATA_FORMAT: FLOAT")
  w_bov("VARIABLE: %s", vn)
  w_bov("DATA_COMPONENTS: %d", dc)
  w_bov("CENTERING: zonal")
  w_bov("DATA_ENDIAN: LITTLE")
  w_bov("BRICK_ORIGIN: 0 0 0")
  w_bov("BRICK_SIZE: %d %d %d", sz)
endfunction

function ini_bov(f); global bov_f; bov_f = fopen(f, "w"); endfunction
function fin_bov();  global bov_f; fclose(bov_f);         endfunction

function ini_val(f); global val_f; val_f = fopen(f, "w"); endfunction
function fin_val();  global val_f; fclose(val_f);         endfunction

function bov(S)
  ini_bov("o.bov");
  bov0(S);
  fin_bov();
endfunction

function write(S)
  bov(S)
  values(S)
endfunction

function ini(); global a; a = argv();     endfunction
function r = c(); global a; r = numel(a); endfunction
function shift(); global a; a = {a{2:end}}; endfunction
# [h]ea[d]
function r = hd(); global a; r = a{1}; endfunction

ini();
o = hd(); shift();
n = 1; S = {};
while c() > 0
  D = read(hd()); shift();
  S = add(S, D, n++);
endwhile
write(S)
