#!/usr/bin/env octave-qf

1;

function usg()
  msg("usage: u.avg o.bov [field.h5]..\n");
  msg("average field files");
  exit(1);
endfunction
function msg(fmt, varargin); fprintf(stderr(), fmt, varargin{:}); endfunction
function D = read(f)
  if (!fexist(f)); msg("u.avg: wrong file: %s", f); exit(1); endif
  D = load(f);
  D = orderfields(D); # alphabetically
  D = structfun(@squeeze, D, "UniformOutput", false);
endfunction

function S = add0(S, D, n, f)
  s = S.(f); x = D.(f);
  # moving sum
  s  = (n - 1) * s + x;
  s /= n;
  S.(f) = s;
endfunction
function S = add1(S, D, n)
  ff = fieldnames(S);
  nf = numel(ff);
  for i = 1:nf; f = ff{i}; S = add0(S, D, n, f); endfor
endfunction
function S = add(S, D, n)
  if n == 1; S = D; else S = add1(S, D, n); endif
endfunction

function values(S, name)
  ini_val(name);
  values0(S)
  fin_val();
endfunction

function S = cellfun0(f, S, varargin)
  S = cellfun(f, S, "UniformOutput", false, varargin{:});
endfunction

function values0(S)
  S = struct2cell(S);
  S = cellfun0(@(v) v(:), S);
  S = horzcat(S{:});
  S = S'(:);
  w_val(S, "single");
endfunction

function w_bov(fmt, varargin)
  global bov_f
  fmt = strcat(fmt, "\n");
  fprintf(bov_f, fmt, varargin{:});
endfunction

function w_val(v)
  global val_f
  fwrite(val_f, v, "single");
endfunction

function bov0(S, val_name)
  sz = size(S.u);
  dc = numel(fieldnames(S));
  w_bov("DATA_FILE: %s", val_name)
  w_bov("DATA_SIZE: %d %d %d", sz)
  w_bov("DATA_FORMAT: FLOAT")
  w_bov("VARIABLE: D")
  w_bov("DATA_COMPONENTS: %d", dc)
  w_bov("CENTERING: zonal")
  w_bov("DATA_ENDIAN: LITTLE")
  w_bov("BRICK_ORIGIN: 0 0 0")
  w_bov("BRICK_SIZE: %d %d %d", sz)
endfunction

function ini_bov(f); global bov_f; bov_f = fopen(f, "w"); endfunction
function fin_bov();  global bov_f; fclose(bov_f);         endfunction

function ini_val(f); global val_f; val_f = fopen(f, "w"); endfunction
function fin_val();  global val_f; fclose(val_f);         endfunction

function bov(S, o, val_name)
  ini_bov(o);
  bov0(S, val_name);
  fin_bov();
endfunction

function write(S, o)
  if isempty(S); msg("u.avg: no data"); exit(1); endif
  [dir, name] = fileparts(o);
  val_name = strcat(name, ".values");
  val_full = fullfile(dir, val_name);
  values(S, val_full);
  bov(S, o, val_name)
endfunction

function ini(); global a; a = argv();     endfunction
function r = c(); global a; r = numel(a); endfunction
function shift(); global a; a = {a{2:end}}; endfunction
# [h]ea[d]
function r = hd(); global a; r = a{1}; endfunction
function r = eq(a, b); r = strcmp(a, b); endfunction
function r = fexist(f); r = exist(f, "file"); endfunction

ini();
if eq(hd(), "-h"); usg(); endif

o = hd(); shift();
n = 1; S = {};
while c() > 0
  D = read(hd()); shift();
  S = add(S, D, n++);
endwhile
write(S, o)
