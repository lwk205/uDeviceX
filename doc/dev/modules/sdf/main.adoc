= signed distance function (sdf)
:lext: .adoc
:src: ../../../../src
:stem: latexmath

The Signed Distance Function (SDF) stem:[S(x, y, z)] is used to give the distance from a
given position to the wall.
The sign of the SDF field tells if the position is inside or outside
the wall.

Conventions:

* stem:[S(x,y,z) < -1] : inside domain, far from wall
* stem:[S(x,y,z) < 0] : inside domain
* stem:[S(x,y,z) = 0] : wall interface
* stem:[S(x,y,z) > 0] : inside wall
* stem:[S(x,y,z) > 1] : inside wall, far from surface

Example of sdf function in 2D:

image::{include}/sdf.png[pdfwidth=70%]

The above example denotes a circular wall of radius 2.
The isosurface stem:[S(x,y,z) = 0] is located at the wall interface.

== bounce back

Particles crossing the wall surface are bounced back into the domain.
Define:

* stem:[\mathbf{r}_0, \mathbf{v}_0] position and velocity before the particle has
  crossed the surface 
* stem:[\mathbf{r}_1, \mathbf{v}_1] position and velocity after the particle has
  crossed the surface, not bounced back
* stem:[\mathbf{r}_n, \mathbf{v}_n] position and velocity after bounce-back
* stem:[\mathbf{r}_w, \mathbf{v}_w] position and velocity of the wall
  at collision point

The collision point is found by solving for the collision time stem:[h]

[stem]
++++
S(\mathbf{r}_0 + h \mathbf{v}_0) = 0
++++

with Newton iterations.
We obtain stem:[\mathbf{r}_w = \mathbf{r}_0 + h \mathbf{v}_0].

The bounced particle is set to

[stem]
++++
\mathbf{r}_n = \mathbf{r}_w + (dt - h) \mathbf{v}_n \\
\mathbf{v}_n = 2 \mathbf{v}_w - \mathbf{v}_0
++++


== interface

allocate, deallocate the structure:

[source,cpp]
----
include::{src}/wall/sdf/imp.h[tag=mem]
----

interface:

[source,cpp]
----
include::{src}/wall/sdf/imp.h[tag=int]
----
<1> generate the sdf field from file "sdf.dat"
<2> get view to be passed to kernels

device interface:

[source,cpp]
----
include::{src}/wall/sdf/dev.h[tag=int]
----
<1> returns true if position is far inside the domain (approximation)
<2> returns the sdf value at given position (linear interpolation)


Bounce back from wall:

[source,cpp]
----
include::{src}/wall/sdf/imp.h[tag=bounce]
----

Sorting tools:
[source,cpp]
----
include::{src}/wall/sdf/imp.h[tag=tools]
----
<1> extract wall particles from solvent particles. Solvent particles
    which are not inside the domain are not kept.
<2> label `nc` objects of `nv` particles to inside domain or not.

== submodules

* `field`: read sdf field from a file
* `bounce`: bounce back particles
* `label`: label which particle stays in bulk, turns into wall, or
  deleted
